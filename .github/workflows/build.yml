name: Build

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v3
    
    # Core library is built separately and linked manually
    
    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.0.0'
    
    - name: Install xcodegen
      run: |
        brew install xcodegen
    
    - name: Generate Xcode project
      run: |
        xcodegen generate
    
    - name: Build iOS app
      run: |
        mkdir -p build
        # First create the archive
        CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO CODE_SIGNING_IDENTITY="" xcodebuild -project Terracotta.xcodeproj -scheme Terracotta -destination 'generic/platform=iOS' -configuration Release archive -archivePath build/Terracotta.xcarchive
    
    - name: Export IPA
      run: |
        # Export the archive (no -scheme flag needed for exportArchive)
        CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO CODE_SIGNING_IDENTITY="" xcodebuild -exportArchive -archivePath build/Terracotta.xcarchive -exportPath build -exportOptionsPlist <(echo '<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>method</key><string>development</string><key>teamID</key><string></string><key>signingStyle</key><string>automatic</string><key>compileBitcode</key><false/></dict></plist>')
