name: Build

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v3
    
    # Core library is built separately and linked manually
    
    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.0.0'
    
    - name: Install xcodegen
      run: |
        brew install xcodegen
    
    - name: Generate Xcode project
      run: |
        xcodegen generate
    
    - name: Build iOS app
      run: |
        mkdir -p build
        # First create the archive
        CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO CODE_SIGNING_IDENTITY="" xcodebuild -project Terracotta.xcodeproj -scheme Terracotta -destination 'generic/platform=iOS' -configuration Release archive -archivePath build/Terracotta.xcarchive
    
    - name: Export IPA
      run: |
        # Create export options plist file - use debugging method without signing
        cat > build/ExportOptions.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>debugging</string>
            <key>compileBitcode</key>
            <false/>
            <key>signingStyle</key>
            <string>manual</string>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>teamID</key>
            <string>PLACEHOLDER</string>
            <key>thinning</key>
            <string>&lt;none&gt;</string>
        </dict>
        </plist>
        EOF
        # Export the archive
        CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO CODE_SIGNING_IDENTITY="" xcodebuild -exportArchive -archivePath build/Terracotta.xcarchive -exportPath build -exportOptionsPlist build/ExportOptions.plist
    
    - name: Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Terracotta-IPA
        path: build/*.ipa
        retention-days: 30